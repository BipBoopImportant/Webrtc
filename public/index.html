<!DOCTYPE html>
<html>
<head>
    <title>TeslaTouch Stream</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background-color: #000; }
        #video-container { position: relative; width: 100%; height: 100%; }
        video { width: 100%; height: 100%; object-fit: contain; }
        #touch-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; }
    </style>
</head>
<body>
    <div id="video-container">
        <video id="videoElement" autoplay playsinline muted></video>
        <div id="touch-overlay"></div>
    </div>

    <script>
        const videoElement = document.getElementById('videoElement');
        const touchOverlay = document.getElementById('touch-overlay');
        const params = new URLSearchParams(window.location.search);
        const mode = params.get('mode') || 'webrtc'; // Default to webrtc (Hotspot mode)

        if (mode === 'hls') {
            // --- INTERNET MODE (HLS) ---
            console.log("Starting in HLS (Internet) Mode");
            document.getElementById('touch-overlay').style.display = 'none'; // No touch in this mode
            const videoSrc = '/live/stream/index.m3u8';
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(videoSrc);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = videoSrc;
            }
        } else {
            // --- HOTSPOT MODE (WebRTC) ---
            console.log("Starting in WebRTC (Hotspot) Mode");
            const ws = new WebSocket(`wss://${window.location.host}/webrtc`);
            const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
            let touchDataChannel;

            pc.ontrack = (event) => {
                videoElement.srcObject = event.streams[0];
            };

            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    ws.send(JSON.stringify({ type: 'ice-candidate', candidate: event.candidate }));
                }
            };
            
            pc.ondatachannel = (event) => {
                touchDataChannel = event.channel;
                setupTouchControls();
            };

            ws.onmessage = async (event) => {
                const message = JSON.parse(event.data);
                if (message.type === 'offer') {
                    await pc.setRemoteDescription(new RTCSessionDescription(message.sdp));
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    ws.send(JSON.stringify({ type: 'answer', sdp: pc.localDescription }));
                } else if (message.type === 'ice-candidate') {
                    await pc.addIceCandidate(new RTCIceCandidate(message.candidate));
                }
            };

            function setupTouchControls() {
                function sendTouchEvent(type, e) {
                    if (!touchDataChannel || touchDataChannel.readyState !== 'open') return;
                    const rect = touchOverlay.getBoundingClientRect();
                    const x = (e.clientX - rect.left) / rect.width;
                    const y = (e.clientY - rect.top) / rect.height;
                    if (x < 0 || x > 1 || y < 0 || y > 1) return;
                    touchDataChannel.send(JSON.stringify({ type, x, y }));
                }
                touchOverlay.addEventListener('mousedown', e => sendTouchEvent('down', e));
                touchOverlay.addEventListener('mouseup', e => sendTouchEvent('up', e));
            }
        }
    </script>
</body>
</html>
